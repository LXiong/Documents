# iOS逆向截取参数

这两天用 THEOS 工具成功逆向了竞品的App，hook 到了我们想要的参数，并成功验证了参数的正确性。在此将逆向的过程记录下来。

##准备工作
### 越狱
首先需要一部越狱的 iPhone，目前最高的越狱版本是iOS10.2，我们所使用的机型是 iPhone5，配上 iOS8.3的系统。
越狱的过程就不说了，玩过 iPhone 的应该都会，下载 pp 助手一键越狱，非常简单。

### Theos 的配置与安装
Theos的配置与安装算是比较简单的，按照官方给的步骤来操作，问题不大。Theos的官方文档地址“官方Wiki”，其中给出了如何安装和配置Theos, 本部分内容也是按照官方的Wiki来提供的，当然进行该部分操作时，要保证你本地已经安装了Homebrew, 可以使用brew命令来安装一些依赖包。brew其实类似于Linux中的yum或者apt-get，就是一个包管理工具。如果你本地没有安装brew，那么请求自行Google，从而完成对brew的安装。
#### 1、安装dpkg
``` bash
brew install dpkg

```
终端中使用如上命令安装 dpkg 工具，dpkg 是 Debian Packager的缩写，是用来打包 deb 的工具。Theos 开放的插件都将以 deb 的格式进行发布。
#### 2、安装 ldid
``` bash
brew install ldid
```
用来为 iOS 文件签名的工具
#### 3、终极工具 Theos 安装
**安装之前先指定 Theos 的路径**

``` bash
export THEOS=/opt/theos
```

再从 git 拉取 Theos 工具
``` bash
git clone --recursive https://github.com/theos/theos.git
```
#### 4、配置CydiaSubstrate
这里需要注意，在网上所找的越狱手机路径中是找不到这个文件的，我将这个文件上传至网盘[传送门](https://pan.baidu.com/s/1skZRGmh)

#### 5、环境变量设置
``` bash
export THEOS=theos文件所在路径
```

## 开始逆向前的工程配置
上面搭完Theos 的环境后，开始创建工程并编译安装
### 1、新建工程
使用命令

```bash
opt/theos/bin/nic.pl
```

来新建工程，theos 会一步一步引导你来创建
![img_1](http://images2015.cnblogs.com/blog/545446/201607/545446-20160728101706700-229365119.png)
选择11创建 tweak 工程
（1）输入你的工程的名字（Project Name，必选项）。

（2）输入包名（Package Name），包名的命名规则一般是你们公司域名的倒写，然后后边加上你的工程名字.

（3）输入作者的名字（Author/Maintainer Name）.

（4）然后输入 App 的 bundle identity（bundle identity）.

### 2、初始化 Makefile 文件
Makefile文件就在你创建好的工程文件夹下，需要手动配置一下东西
![img_2](http://images2015.cnblogs.com/blog/545446/201607/545446-20160729102735434-596676815.png)
第一行是你的越狱手机的ip 地址，待会要链接上去进行部署;
第二行是工程配置;
第三行是你本地所用 Xcode 的 模拟器的 SDK,我下了个老的 Xcode7，使用的是9.3的 SDK;
第四行是指定可以运行的版本;
在第四行下面可以添加
```bash
WelcomeWagon_FRAMEWORKS = UIKit
```
来导入 UIKit 框架，否则在编译文件中写 UI 控件会报错~~
下面的都是基本配置，不做说明

## App 砸壳、获取头文件信息
为了能 hook 到所需要的类，要对原版 ipa 文件进行处理
### Clutch 砸壳
```bash
git clone https://github.com/KJCracks/Clutch
```
cd 进文件夹使用 Xcode 构建可执行文件

```bash
xcodebuild -project Clutch.xcodeproj -configuration Release ARCHS="armv7 armv7s arm64" build
```
将生成的可执行文件(在 build 文件夹下)利用 itools 拷贝到越狱手机的 user/bin/下，或使用 scp 命令进行拷贝

```bash
scp Clutch/clutch root@<your.device.ip>:/usr/bin/
```
ssh到越狱手机上(越狱手机先在 Cydia中安装 ssh)

 cd 到/usr/bin/下，执行
 
 ```bash
 clutch -i
 ```
 命令
 
 找了张图做示例：
 ![img_3](http://upload-images.jianshu.io/upload_images/931214-d0f6b241601f8f0a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/format/jpg)
 如图使用
 
 ```bash
 clutch -d com.tencent.xin
 ```
 进行砸壳，最终会生成一个 ipa，途径会在终端中显示，将它拷贝到 Mac 上。
 
### 获取头文件信息
使用 class-dump 工具，参考链接[传送门](http://blog.csdn.net/ioszhuang2015/article/details/68928741)
从最终获取的头文件中分析到，key 应该是在这里被调用的：

```bash
//
//     Generated by class-dump 3.5 (64 bit).
//
//     class-dump is Copyright (C) 1997-1998, 2000-2001, 2004-2013 by Steve Nygard.
//

#import "NSString.h"

@interface NSString (HMAC)
- (id)HMACWithSecret2:(id)arg1;
- (id)HMACWithSecret:(id)arg1;
@end
```
只是不知道是第一个方法还是第二个方法里是真实的 key，这时候就要用到钩子了

## 开始上钩子
打开之前配置好的工程，打开Tweak.xm文件，利用logify.pl进行初始化，具体命令如下：

```bash
/opt/theos/bin/logify.pl /Users/dt/Downloads/HotTagsClass/PonyBayApiClient.h  > /Users/dt/hookmkey/Tweak.xm
```

打开Tweak.xm 文件，可以看到有这么一个实现方法

```bash
%hook NSString
- (id)HMACWithSecret2:(id)arg1 { %log; id r = %orig; HBLogDebug(@" = %@", r); return r; }
- (id)HMACWithSecret:(id)arg1 { %log; id r = %orig; HBLogDebug(@" = %@", r); return r; }
%end

```
这是Logos 语言，有兴趣的可以看一下，其实质是用宏将 runTime 的一些方法封装起来，达到动态拦截消息的效果。
%hook NSString就是我们需要挂钩子的类，HBLogDebug(@" = %@", r); 将返回值打印出来
我们在这个方法中写一些拦截操作,如图：

```bash
%hook NSString
- (id)HMACWithSecret2:(id)arg1 {
 	%log; 
	 id r = %orig; 
 	HBLogDebug(@" = %@", r); 
 	UIAlertView *alert = [[UIAlertView alloc]initWithTitle:@"第一个 key" 
 			message：arg1
 			delegate:nil
 			cancelButtonTitle@"ok" otherButtonTitles:nil];
 	[alert show];
 	return r; 
 	}
- (id)HMACWithSecret:(id)arg1 { %log; id r = %orig; HBLogDebug(@" = %@", r); return r; }
%end
```
虽然 logify已经帮我们把信息写进了 syslog，但是日志变动太快很容易漏看，我们可以加一个 alertview来显示拦截到的 key。

写完之后保存，在控制台 cd 到工程文件夹，用

```bash
make package install
```
命令来编译、打包、部署，最后打开你手机上的 App，进行和往常一样的操作，你的代码会自动去拦截这个方法，弹出弹框。

**注意，创建工程时的要你输入的 bundle identity必须是你想要hook的 App 的 bundle identity，否则无效**

## 小结
总的来说坑非常多，网上找的资料大多比较老，有些东西已经不适用，需要手动实践。利用钩子截取参数的本质其实是利用的OC 的 Runtime 动态机制，深入理解还是很有意思的。

## 参考资料（坑比较多）
[iOS逆向工程之Theos](http://www.cnblogs.com/ludashi/p/5714095.html)

[iOS 逆向工程之 Clutch砸壳](http://www.jianshu.com/p/4cfd86600ced)

[使用Logify跟踪函数调用](https://wizardforcel.gitbooks.io/ios-sec-wiki/content/chapter8/issue8-3.html)



 
 